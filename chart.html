<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>BTCUSDT Chart</title>
  <style>
    body { margin: 0; background: white; }
    canvas { display: block; margin: auto; background: white; }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <canvas id="chart" width="648" height="480"></canvas>
  <script>
    async function getData() {
      const end = Math.floor(Date.now() / 1000);
      const start = end - 12 * 60 * 60; // posledních 12 hodin
      const url = `https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=15m&startTime=${start * 1000}&endTime=${end * 1000}`;
      const response = await fetch(url);
      const raw = await response.json();
      return raw.map(d => ({
        t: d[0], // Timestamp
        o: +d[1], // Open price
        h: +d[2], // High price
        l: +d[3], // Low price
        c: +d[4]  // Close price
      }));
    }

    function draw(candles) {
      const canvas = document.getElementById('chart');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Přizpůsobené paddingy pro nové rozložení textu a os
      const paddingLeft = 20;   // Odsazení vlevo pro akt. cenu
      const paddingRight = 70;  // Odsazení vpravo pro osu Y a popisky
      const paddingTop = 45;    // Odsazení shora pro horní texty
      const paddingBottom = 60; // Odsazení zdola pro spodní texty

      const w = canvas.width - paddingLeft - paddingRight; // Šířka grafové plochy
      const h = canvas.height - paddingTop - paddingBottom; // Výška grafové plochy
      const n = candles.length; // Počet svíček

      // Výpočet časového a cenového rozsahu pro škálování grafu
      const times = candles.map(c => c.t);
      const minTime = Math.min(...times);
      const maxTime = Math.max(...times);
      const prices = candles.flatMap(c => [c.l, c.h]);
      
      // minPrice a maxPrice zaokrouhlíme na násobky 500 pro čisté popisky osy
      const minPrice = Math.floor(Math.min(...prices) / 500) * 500;
      const adjustedMinPrice = Math.max(minPrice, Math.min(...prices)); // Zajištění, aby osa nezačínala příliš vysoko/nízko
      const maxPrice = Math.ceil(Math.max(...prices) / 500) * 500;

      // Měřítka pro převod datových souřadnic na pixelové souřadnice
      const scaleX = w / (maxTime - minTime);
      const scaleY = h / (maxPrice - adjustedMinPrice); 

      ctx.strokeStyle = 'black'; // Barva pro čáry (osy, svíčky)
      ctx.fillStyle = 'black';   // Barva pro výplně (text, plné svíčky)
      ctx.textBaseline = 'middle'; // Výchozí zarovnání textu na střed (vertikálně)

      // --- Y osa (plná vertikální čára) na PRAVÉ STRANĚ ---
      const axisY_XPosition = paddingLeft + w; // X pozice pravého okraje grafu
      ctx.beginPath();
      ctx.moveTo(axisY_XPosition, paddingTop);
      ctx.lineTo(axisY_XPosition, paddingTop + h);
      ctx.stroke();

      // --- Popisky cen na ose Y (PRAVÁ STRANA od osy) ---
      ctx.font = '12px Roboto, sans-serif'; 
      ctx.textAlign = 'left'; // Text zarovnaný doleva, aby "začínal" u osy a šel doprava
      for (let p = minPrice; p <= maxPrice; p += 500) { 
        const y = paddingTop + h - (p - adjustedMinPrice) * scaleY; 
        
        // Speciální ošetření pro nejnižší cenu, aby byla zarovnaná NAD linkou osy
        if (p === minPrice) { 
          ctx.textBaseline = 'bottom'; 
          ctx.fillText(p.toLocaleString(), axisY_XPosition + 5, y + 2); // 5px napravo od osy
          ctx.textBaseline = 'middle'; // Vrátíme zpět pro ostatní popisky
        } else {
          ctx.fillText(p.toLocaleString(), axisY_XPosition + 5, y); // 5px napravo od osy
        }
      }
      ctx.setLineDash([]); // Resetovat na plnou čáru pro jistotu

      // --- X osa (plná vodorovná čára dole) ---
      ctx.beginPath();
      ctx.moveTo(paddingLeft, paddingTop + h);
      ctx.lineTo(paddingLeft + w, paddingTop + h);
      ctx.stroke();

      // --- Candlesticky (svíčky) ---
      const barWidth = Math.max(2, w / n * 0.6); // Dynamická šířka svíček
      candles.forEach(c => {
        const x = paddingLeft + (c.t - minTime) * scaleX; // X pozice středu svíčky
        const yOpen = paddingTop + h - (c.o - adjustedMinPrice) * scaleY; 
        const yClose = paddingTop + h - (c.c - adjustedMinPrice) * scaleY; 
        const yHigh = paddingTop + h - (c.h - adjustedMinPrice) * scaleY; 
        const yLow = paddingTop + h - (c.l - adjustedMinPrice) * scaleY;   

        // Přeskočí svíčky, které by zasahovaly mimo grafovou plochu
        if (x - barWidth / 2 < paddingLeft || x + barWidth / 2 > paddingLeft + w) return; 

        ctx.strokeStyle = 'black'; // Barva knotů a okrajů svíček
        ctx.beginPath();
        ctx.moveTo(x, yHigh); // Knot - shora
        ctx.lineTo(x, yLow);  // Knot - dolů
        ctx.stroke();

        const xBar = x - barWidth / 2; // Levý okraj těla svíčky
        if (c.c >= c.o) { // Rostoucí svíčka (close >= open)
          ctx.fillStyle = 'black'; // Vyplní se černě
          ctx.fillRect(xBar, yClose, barWidth, yOpen - yClose);
        } else { // Klesající svíčka (close < open)
          ctx.fillStyle = 'white'; // Vyplní se bíle
          ctx.fillRect(xBar, yClose, barWidth, yOpen - yClose);
          ctx.strokeRect(xBar, yClose, barWidth, yOpen - yClose); // Kreslí černý okraj
        }
      });

      // --- Popisky časů na ose X (dole) ---
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillStyle = 'black';
      ctx.font = '12px Roboto, sans-serif'; 

      // Iterujeme přes každou celou hodinu v rozsahu grafu
      const firstHourTimestamp = Math.ceil(minTime / (1000 * 60 * 60)) * (1000 * 60 * 60);

      for (let t = firstHourTimestamp; t <= maxTime; t += (1000 * 60 * 60)) {
        const x = paddingLeft + (t - minTime) * scaleX;

        // Nepřekračovat hranice grafu
        if (x < paddingLeft || x > paddingLeft + w) continue;

        const dateAtTime = new Date(t);
        const hour = dateAtTime.getHours(); // Hodina v lokálním časovém pásmu (CEST)
        const label = `${('0' + hour).slice(-2)}:00`; // Formát HH:MM

        ctx.fillText(label, x, paddingTop + h + 5);
      }

      // --- Nová vodorovná čárkovaná linka na AKTUÁLNÍ ceně ---
      const currentPrice = candles[candles.length - 1].c; 
      const yCurrentPrice = paddingTop + h - (currentPrice - adjustedMinPrice) * scaleY;

      ctx.setLineDash([5, 5]); // Nastaví delší čárky pro výraznější linku
      ctx.strokeStyle = 'black';
      ctx.beginPath();
      ctx.moveTo(paddingLeft, yCurrentPrice);
      ctx.lineTo(paddingLeft + w, yCurrentPrice);
      ctx.stroke();
      ctx.setLineDash([]); // Resetovat na plnou čáru

      // --- Zobrazení AKTUÁLNÍ ceny vlevo u čárkované linky ---
      const currentPriceToDisplay = Math.round(currentPrice); // Zaokrouhlení na celé číslo
      
      ctx.fillStyle = 'black';
      ctx.font = '12px Roboto, sans-serif'; // Normální (netučné) písmo
      ctx.textAlign = 'left'; 
      ctx.textBaseline = 'bottom'; // Zarovná text nad Y-souřadnici

      // Text bude 5px od levého okraje canvasu, a 5px nad čárkovanou linkou
      ctx.fillText(currentPriceToDisplay.toLocaleString(), 5, yCurrentPrice - 5); 

      // --- Horní řádek textů: Ticker, Nákupní cena, Aktuální cena, Profit ---
      const averageBuyPrice = 78000; // Pevně zadaná nákupní cena
      // const currentPrice = candles[candles.length - 1].c; // Aktuální cena už definována výše

      let profitPercentage = 0;
      if (averageBuyPrice > 0) {
        profitPercentage = ((currentPrice - averageBuyPrice) / averageBuyPrice) * 100;
      }

      const currentPriceRounded = Math.round(currentPrice);

      // Sestavení jednotlivých textových segmentů pro horní řádek
      const tickerText = 'BTCUSDT';
      const avgBuyPriceText = `Nákupní cena: ${averageBuyPrice.toLocaleString()} USDT`;
      const currentPriceText = `Aktuální cena: ${currentPriceRounded.toLocaleString()} USDT`;
      const profitFormattedText = `${profitPercentage.toFixed(2)}%`;

      const textSegments = [
          tickerText,
          avgBuyPriceText,
          currentPriceText,
          `Profit: ${profitFormattedText}`
      ];

      const spacingBetweenSegments = 20; // Mezera mezi segmenty

      let totalWidth = 0;
      ctx.font = 'bold 12px Roboto, sans-serif'; // Font pro horní texty

      // Vypočítáme celkovou šířku horního řádku pro centrování
      const segmentWidths = textSegments.map(segment => {
          const width = ctx.measureText(segment).width;
          totalWidth += width;
          return width;
      });

      totalWidth += (textSegments.length - 1) * spacingBetweenSegments;

      const startX = (canvas.width / 2) - (totalWidth / 2); // Počáteční X pozice pro vycentrování
      const topRowY = 20; // Y pozice horního řádku

      let currentX = startX;

      // Vykreslení jednotlivých segmentů horního řádku
      ctx.textAlign = 'left'; // Dočasné nastavení pro postupné vykreslování
      ctx.fillStyle = 'black';

      ctx.fillText(tickerText, currentX, topRowY);
      currentX += segmentWidths[0] + spacingBetweenSegments;

      ctx.fillText(avgBuyPriceText, currentX, topRowY);
      currentX += segmentWidths[1] + spacingBetweenSegments;

      ctx.fillText(currentPriceText, currentX, topRowY);
      currentX += segmentWidths[2] + spacingBetweenSegments;

      // Profit text s dynamickou barvou
      if (profitPercentage >= 0) {
          ctx.fillStyle = 'black'; 
      } else {
          ctx.fillStyle = 'red'; 
      }
      ctx.fillText(`Profit: ${profitFormattedText}`, currentX, topRowY);

      // --- Spodní řádek textů: "Poslední aktualizace:", Datum, Čas a Time Frame ---
      const lastCandleTime = new Date(candles[candles.length - 1].t);

      // Formátování data (DD.MM.RRRR)
      const day = ('0' + lastCandleTime.getDate()).slice(-2);
      const month = ('0' + (lastCandleTime.getMonth() + 1)).slice(-2);
      const year = lastCandleTime.getFullYear();
      const formattedDate = `${day}.${month}.${year}`;

      // Formátování časů (bez sekund)
      const cestHours = lastCandleTime.getHours();
      const cestMins = ('0' + lastCandleTime.getMinutes()).slice(-2);

      const utcHours = lastCandleTime.getUTCHours();
      const nyHours = (utcHours - 4 + 24) % 24; // NY je UTC-4
      const nyMins = ('0' + lastCandleTime.getUTCMinutes()).slice(-2);

      // Sestavení textových segmentů pro spodní řádek
      const updateText = `Poslední aktualizace:`;
      const timeAndDateText = `${formattedDate} ${cestHours}:${cestMins} CEST | ${nyHours}:${nyMins} NY`;
      const timeframeText = `Time Frame: 15 minut`; // Pevně daný časový rámec

      const bottomTextSegments = [
          updateText,
          timeAndDateText,
          timeframeText
      ];

      let totalBottomWidth = 0;
      ctx.font = '12px Roboto, sans-serif'; // Font pro spodní texty

      // Vypočítáme celkovou šířku spodního řádku pro centrování
      const bottomSegmentWidths = bottomTextSegments.map(segment => {
          const width = ctx.measureText(segment).width;
          totalBottomWidth += width;
          return width;
      });

      const spacingBottomSegments = 20; // Mezera mezi segmenty
      totalBottomWidth += (bottomTextSegments.length - 1) * spacingBottomSegments;

      const bottomStartX = (canvas.width / 2) - (totalBottomWidth / 2); // Počáteční X pozice pro vycentrování
      const bottomTextY = canvas.height - 20; // Y pozice spodního řádku

      let currentBottomX = bottomStartX;

      // Vykreslení jednotlivých segmentů spodního řádku
      ctx.textAlign = 'left'; 
      ctx.fillStyle = 'black';

      ctx.fillText(updateText, currentBottomX, bottomTextY);
      currentBottomX += bottomSegmentWidths[0] + spacingBottomSegments;

      ctx.fillText(timeAndDateText, currentBottomX, bottomTextY);
      currentBottomX += bottomSegmentWidths[1] + spacingBottomSegments;

      ctx.fillText(timeframeText, currentBottomX, bottomTextY);
    }

    getData().then(draw);
  </script>
</body>
</html>